name: V2 Build
on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0/4 * * *'
env:
  REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
  REPO: ${{ secrets.REPO }}

jobs:
  Windows-build:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: 版本对比（简化版，只判断自己仓库）
        run: |
          try {
              $response = Invoke-WebRequest -Uri https://api.github.com/repos/czgreat/MoviePilot/git/refs/heads/v2 -ErrorAction Stop | ConvertFrom-Json
              $latest_commit_short = $response.object.sha.Substring(0, 7)
              echo "czgreat/MoviePilot最新commit: $latest_commit_short"
          } catch {
              Write-Output "获取czgreat/MoviePilot分支失败，直接执行打包"
              exit 0
          }

          try {
              $response4 = Invoke-WebRequest -Uri https://api.github.com/repos/czgreat/Windows-MoviePilot/releases/latest -ErrorAction Stop | ConvertFrom-Json
              $latest_release_tag = $response4.tag_name
              echo "最新Release标签: $latest_release_tag"
              
              if ($latest_release_tag -match $latest_commit_short) {
                  Write-Output "版本相同，无需更新"
                  exit 1
              } else {
                  Write-Output "检测到新commit，执行打包"
              }
          } catch {
              Write-Output "首次打包，无历史Release，执行打包"
          }

      - name: 拉取exe打包脚本（你的czgreat/Windows-MoviePilot）
        run: |
          git clone https://${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/czgreat/Windows-MoviePilot.git -b main Inno-Setup-MoviePilot
        working-directory: ${{ github.workspace }}

      - name: 拉取MoviePilot源码（你的czgreat/MoviePilot）
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: v2
          repository: czgreat/MoviePilot
          path: 'MoviePilot'
          fetch-depth: 2

      - name: 初始化Python 3.12.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.8'
          cache: 'pip'

      - name: 安装依赖包
        id: INSTALL_PACKAGES
        run: |
          cd MoviePilot
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          Remove-Item ".\config\app.env" -ErrorAction SilentlyContinue
          
          $hash_version = git log -2 --pretty=format:"%h" 2>&1 | Select-Object -Skip 1
          if (-not $hash_version) {
              $hash_version = git log -1 --pretty=format:"%h"
          }
          $GIT_LOG = git log -2 --oneline 2>&1 | Select-Object -Last 1
          if (-not $GIT_LOG) {
              $GIT_LOG = "首次打包"
          }
          
          echo "KEYM=$GIT_LOG" >> $env:GITHUB_OUTPUT
          echo "HASH_VERSION=$hash_version" >> $env:GITHUB_ENV
          echo "当前commit版本: $hash_version"

          cd app/helper
          Invoke-WebRequest -URI "https://raw.githubusercontent.com/jxxghp/MoviePilot-Resources/main/resources.v2/sites.cp312-win_amd64.pyd" -OutFile "sites.cp312-win_amd64.pyd" -ErrorAction SilentlyContinue
          Invoke-WebRequest -URI "https://raw.githubusercontent.com/jxxghp/MoviePilot-Resources/main/resources.v2/user.sites.v2.bin" -OutFile "user.sites.v2.bin" -ErrorAction SilentlyContinue
          
          cd ../plugins/
          Invoke-WebRequest -Uri "https://github.com/jxxghp/MoviePilot-Plugins/archive/refs/heads/main.zip" -OutFile "MoviePilot-Plugins-main.zip" -ErrorAction SilentlyContinue
          Expand-Archive -Path "MoviePilot-Plugins-main.zip" -DestinationPath "MoviePilot-Plugins-main" -ErrorAction SilentlyContinue
          Move-Item -Path "MoviePilot-Plugins-main/MoviePilot-Plugins-main/plugins.v2/*" -Destination . -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "MoviePilot-Plugins-main.zip" -ErrorAction SilentlyContinue
          Remove-Item -Path "MoviePilot-Plugins-main" -Recurse -Force -ErrorAction SilentlyContinue
          
          Get-ChildItem -Path . -Recurse -Filter "requirements.txt" -ErrorAction SilentlyContinue | ForEach-Object { 
              pip install -r $_.FullName 
          }

      - name: 下载前端文件
        run: |
          $version_file = "./MoviePilot/version.py"
          if (Test-Path $version_file) {
              $FRONTEND_VERSION = Get-Content $version_file | Select-String "FRONTEND_VERSION" | ForEach-Object {$_.ToString().Split('=')[1] }
              $APP_VERSION = Get-Content $version_file | Select-String "APP_VERSION" | ForEach-Object {$_.ToString().Split('=')[1] }
              $FRONTEND_VERSION = $FRONTEND_VERSION.Trim() -replace "'", "" -replace '"', ""
              $APP_VERSION = $APP_VERSION.Trim() -replace "'", "" -replace '"', ""
          } else {
              $FRONTEND_VERSION = "latest"
              $APP_VERSION = "v0.0.0"
          }
          
          echo "前端版本: $FRONTEND_VERSION"
          echo "应用版本: $APP_VERSION"

          mkdir MoviePilot-Frontend -ErrorAction SilentlyContinue
          cd MoviePilot-Frontend
          try {
              $extract_url = "https://github.com/jxxghp/MoviePilot-Frontend/releases/download/$FRONTEND_VERSION/dist.zip"
              Invoke-WebRequest -URI $extract_url -OutFile dist.zip -ErrorAction Stop
              Expand-Archive dist.zip -DestinationPath . -Force
              Move-Item -Path .\dist\* -Destination . -Force -ErrorAction SilentlyContinue
              Remove-Item -Path "dist.zip" -ErrorAction SilentlyContinue
              Remove-Item -Path "dist" -Recurse -ErrorAction SilentlyContinue
          } catch {
              Write-Output "前端下载失败，使用默认版本"
          }

          $tagName = $APP_VERSION.Substring(1)
          echo "FIRST_VERSION=$tagName" >> $env:GITHUB_ENV
          echo "LATEST_VERSION=$tagName.$env:HASH_VERSION" >> $env:GITHUB_ENV

      - name: 打包Python环境
        id: Make_Python_package
        run: |
          echo "最终版本号: $env:LATEST_VERSION"
          echo "KEY=$env:LATEST_VERSION" >> $env:GITHUB_OUTPUT
          
          try {
              $python_dir = python -c "import os; print(os.path.dirname(os.__file__))"
              $python_root_dir = $python_dir.Substring(0, $python_dir.Length - 4)
              mkdir Python3.11 -ErrorAction SilentlyContinue
              cd Python3.11
              cp -r $python_root_dir/* . -ErrorAction SilentlyContinue
          } catch {
              Write-Output "Python环境打包失败，跳过"
          }

      - name: 编译Inno Setup安装包
        run: |
          echo "开始编译exe: $env:LATEST_VERSION"
          Invoke-WebRequest https://jrsoftware.org/download.php/is.exe?site=1 -OutFile is.exe -ErrorAction SilentlyContinue
          Start-Process is.exe -ArgumentList "/VERYSILENT", "/NORESTART", "/SP-","/SUPPRESSMSGBOXES","/DIR=C:\Users\runneradmin\AppData\Local\Temp\inno" -NoNewWindow -Wait -ErrorAction SilentlyContinue
          
          cd Inno-Setup-MoviePilot
          Copy-Item -Path ".\ChineseSimplified.isl" -Destination "C:\Users\runneradmin\AppData\Local\Temp\inno\Languages" -ErrorAction SilentlyContinue
          $iscc_path = "C:\Users\runneradmin\AppData\Local\Temp\inno\iscc"
          if (Test-Path $iscc_path) {
              & $iscc_path "/DMyAppVersion=$env:LATEST_VERSION" build.iss
          } else {
              Write-Output "Inno Setup未安装成功，编译失败"
              exit 1
          }

      - name: 获取上海时间
        run: |
          $currentUtcTime = (Get-Date).ToUniversalTime()
          $shanghaiTimeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
          $shanghaiTime = [System.TimeZoneInfo]::ConvertTimeFromUtc($currentUtcTime, $shanghaiTimeZone)
          $formattedShanghaiTime = $shanghaiTime.ToString("yyyyMMddHHmmss")
          echo "上海时间: $formattedShanghaiTime"
          echo "SHANGHAI_TIMEZONE=$formattedShanghaiTime" >> $env:GITHUB_ENV

      - name: 创建Release并上传exe
        uses: softprops/action-gh-release@v2
        with:
          name: MoviePilot_v${{ env.FIRST_VERSION }}_${{ env.SHANGHAI_TIMEZONE }}_${{ env.HASH_VERSION }}
          tag_name: v${{ env.FIRST_VERSION }}.${{ env.HASH_VERSION }}
          body: |
            打包版本：${{ env.LATEST_VERSION }}
            提交信息：${{ steps.INSTALL_PACKAGES.outputs.KEYM }}
          draft: false
          prerelease: false
          make_latest: true
          files: |
            ./exe/build/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
